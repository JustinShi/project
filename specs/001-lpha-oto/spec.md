# Feature Specification: 币安多用户Alpha代币OTO订单自动交易系统

**Feature Branch**: `001-lpha-oto`  
**Created**: 2025-10-09  
**Status**: Draft  
**Input**: User description: "我想在src\binance建立一个币安的多用户 alpha代币oto订单自动买卖工具，使用ddd结构，使用私有api文档和使用header+cookies发起请求，可以查询用户余额，可以查询用户的交易量，可以根据用户的交易量和配置的目标交易量计算需要交易的循环次数，可以获取websocket推送的成交记录，使用成交记录的最新价格计算订单价格进行oto订单买卖下单，可以监听websocket的订单推送，当oto买卖单完全成交后再进行下一单。"

## Clarifications

### Session 2025-10-09

- Q: 买卖单价格相对于最新成交价的偏移量应该如何计算？ → A: 用户可配置（百分比或固定金额二选一），系统需支持两种模式，用户在配置交易策略时选择使用百分比偏移（如±0.5%）或固定金额偏移（如±0.01 USDT）
- Q: 当用户余额不足时，系统应该如何处理？ → A: 暂停自动交易并通知用户充值，确保每轮交易的订单数量符合配置要求，保证交易质量一致性
- Q: 当WebSocket连接中断时，系统应该如何保证已提交订单状态的准确性？ → A: 连接中断时立即暂停自动交易，重连成功后不自动恢复，需要用户手动核实订单状态并决定是否恢复自动交易，优先保证资金安全
- Q: 当OTO订单部分成交后长时间（超过超时时间）未完全成交时，系统应该如何处理？ → A: 取消整个OTO订单对的所有未成交部分并重新下单（已成交部分无法撤销但计入交易量），重新按最新价格创建新的OTO订单对
- Q: 系统应该如何防止重复提交订单？ → A: 依赖WebSocket实时订单推送维护本地订单状态，只有在确认当前OTO订单对完全成交后才允许创建下一个订单对，通过订单状态机严格控制交易流程
- Q: 价格剧烈波动时如何保护？ → A: 系统监控1分钟内的价格变动百分比，当变动超过用户配置的阈值（如2%）时，立即暂停自动交易以避免在不合理价格下单
- Q: 用户认证信息如何存储和管理？ → A: 用户的headers和cookies存储在数据库中，系统从数据库读取认证信息用于API请求，当认证失效时通知用户需要更新数据库中的认证信息
- Q: 代币符号和精度信息如何管理？ → A: 用户配置时只使用代币简称（如KOGE），系统维护代币简称到不同API符号的映射关系（订单API使用alpha_xxx格式，WebSocket使用其他格式），代币精度信息通过私有API查询后缓存到本地，优先从本地缓存读取，缓存未命中时再调用API更新
- Q: API测试应该如何组织和排序？ → A: API需要按依赖顺序测试：先测试代币信息（获取符号映射和精度），然后测试代币价格（获取实时价格数据），最后测试下单（需要前面获取的符号和价格信息），确保测试数据的依赖关系正确

## User Scenarios & Testing *(mandatory)*

### 测试策略说明

**API测试依赖顺序**：系统的API测试必须按照数据依赖关系顺序执行，确保前置数据准备完成后再执行依赖测试：

1. **第一阶段：代币信息测试**
   - 测试代币符号映射查询（FR-022, FR-025）
   - 测试代币精度信息查询（FR-023, FR-024）
   - 确保代币简称（如KOGE）能正确映射到订单API符号（ALPHA_xxx）和WebSocket符号

2. **第二阶段：代币价格测试**
   - 测试实时价格数据获取（FR-006）
   - 测试价格WebSocket连接和推送
   - 验证价格波动监控功能（FR-020）
   - 前置依赖：需要第一阶段获取的代币符号

3. **第三阶段：订单下单测试**
   - 测试OTO订单创建和提交（FR-008, FR-009）
   - 测试订单价格计算（FR-007）
   - 测试订单状态监控（FR-010, FR-011）
   - 前置依赖：需要第一阶段的代币符号信息和第二阶段的价格数据

4. **第四阶段：完整交易流程测试**
   - 测试完整的交易循环（从下单到成交到下一轮）
   - 测试异常处理（超时、余额不足、连接中断等）
   - 前置依赖：前三阶段所有功能正常

**测试数据隔离**：每个测试阶段应使用独立的测试数据，避免测试间相互影响。

---

### User Story 1 - 查看账户状态和交易数据 (Priority: P1)

作为交易员，我需要能够查看我的账户余额和历史交易量，以便了解当前账户状态并决定交易策略。

**Why this priority**: 这是系统的基础功能，用户必须先了解账户状态才能进行后续交易操作。这是所有其他功能的前置条件。

**Independent Test**: 可以通过登录系统后查看账户信息页面来独立测试，验证余额和交易量数据的准确性和实时性。

**Acceptance Scenarios**:

1. **Given** 用户已成功认证并登录系统，**When** 用户访问账户概览页面，**Then** 系统显示用户的当前可用余额、冻结余额和总余额
2. **Given** 用户已有历史交易记录，**When** 用户查询交易量统计，**Then** 系统显示指定时间段内的累计交易量和交易次数
3. **Given** 多个用户同时使用系统，**When** 每个用户查看自己的账户信息，**Then** 系统正确隔离并显示各自的账户数据

---

### User Story 2 - 配置交易目标和策略 (Priority: P1)

作为交易员，我需要能够设置我的目标交易量和交易参数，以便系统能够根据我的策略自动计算和执行交易。

**Why this priority**: 配置是自动交易的核心，没有明确的目标和策略，系统无法进行自动化操作。这是实现自动交易的必要条件。

**Independent Test**: 可以通过配置界面设置交易参数并保存，验证配置是否正确保存并应用到交易计算中。

**Acceptance Scenarios**:

1. **Given** 用户登录系统，**When** 用户设置目标交易量（如每日目标1000 USDT）和交易代币简称（如KOGE），**Then** 系统保存该配置，自动加载代币符号映射和精度信息，并在交易计算中使用
2. **Given** 用户已设置目标交易量，**When** 系统计算当前已完成交易量与目标的差距，**Then** 系统准确计算出还需执行的交易循环次数
3. **Given** 用户需要修改交易策略，**When** 用户更新配置参数（包括价格偏移、订单数量、超时时间、价格波动阈值、代币简称等），**Then** 系统立即应用新配置到后续交易中
4. **Given** 用户配置价格波动保护阈值（如2%），**When** 配置保存成功，**Then** 系统在后续交易中监控价格波动并在超过阈值时暂停交易
5. **Given** 用户配置代币简称（如KOGE），**When** 系统处理配置，**Then** 系统从本地缓存加载代币的符号映射和精度信息，缓存未命中时自动调用API获取并缓存

---

### User Story 3 - 实时监控市场成交价格 (Priority: P2)

作为交易员，我需要系统能够实时获取Alpha代币的最新成交价格，以便我的订单价格能够基于最新市场数据进行计算。

**Why this priority**: 实时价格是准确定价的基础，确保订单价格合理且有较高的成交概率。这是自动交易质量的保证。

**Independent Test**: 可以通过观察系统显示的价格数据与交易所公开价格的一致性来独立测试实时性和准确性。

**Acceptance Scenarios**:

1. **Given** 系统已连接到价格数据源，**When** 市场发生新的成交，**Then** 系统在1秒内接收并更新最新成交价格
2. **Given** 系统接收到最新成交价格，**When** 需要创建新订单，**Then** 系统使用最新价格作为订单价格计算的基础数据
3. **Given** 价格数据源连接中断，**When** 系统检测到连接异常，**Then** 系统暂停自动交易并通知用户
4. **Given** 系统监控最近1分钟的价格变动，**When** 价格变动超过用户配置的阈值（如2%），**Then** 系统立即暂停自动交易并通知用户价格异常波动

---

### User Story 4 - 自动执行OTO买卖订单 (Priority: P1)

作为交易员，我需要系统能够自动创建并提交OTO（一触发另一）买卖订单对，以便我能够自动化地进行双向交易而无需手动操作。

**Why this priority**: 这是系统的核心自动交易功能，直接实现用户的主要价值诉求——自动化交易。

**Independent Test**: 可以通过配置一组交易参数，观察系统是否成功创建并提交买卖订单对，验证订单的价格、数量等参数是否符合预期。

**Acceptance Scenarios**:

1. **Given** 系统已获取最新市场价格且用户配置有效，**When** 系统触发交易信号，**Then** 系统创建一个买单和一个卖单组成的OTO订单对
2. **Given** OTO订单已创建，**When** 系统提交订单到交易所，**Then** 订单成功进入交易所订单簿并返回订单ID
3. **Given** 订单价格计算规则已配置，**When** 系统计算订单价格，**Then** 买单价格略低于最新成交价，卖单价格略高于最新成交价（具体差价由配置决定）
4. **Given** 用户设置了订单数量参数，**When** 系统创建订单，**Then** 订单数量符合用户配置且不超过账户可用余额

---

### User Story 5 - 监控订单状态并等待完全成交 (Priority: P1)

作为交易员，我需要系统能够实时监控我的OTO订单状态，并在订单完全成交后才进行下一轮交易，以确保交易的连续性和资金的有效利用。

**Why this priority**: 订单状态监控是确保交易循环正确执行的关键，避免资金被多个未完成订单占用导致交易失败。

**Independent Test**: 可以通过提交测试订单并观察系统是否正确识别订单状态变化（部分成交、完全成交、取消等）来独立测试。

**Acceptance Scenarios**:

1. **Given** OTO订单已提交到交易所，**When** 订单状态发生变化（部分成交、完全成交等），**Then** 系统在2秒内接收到状态更新通知
2. **Given** OTO订单买卖双方都完全成交，**When** 系统检测到完全成交状态，**Then** 系统记录本次交易完成并触发下一轮交易
3. **Given** OTO订单部分成交中，**When** 系统检查订单状态，**Then** 系统继续等待而不创建新订单
4. **Given** 订单长时间未完全成交，**When** 超过配置的超时时间，**Then** 系统取消所有未成交部分，将已成交部分计入交易量，并按最新价格重新创建新的OTO订单对

---

### User Story 6 - 多用户并发交易管理 (Priority: P2)

作为平台管理员或多账户交易员，我需要系统支持多个用户同时进行自动交易，且各用户的交易互不干扰，以便实现多账户统一管理。

**Why this priority**: 多用户支持提升系统的规模化能力，允许同时管理多个交易账户，提高运营效率。

**Independent Test**: 可以通过配置多个测试用户账户，同时启动他们的自动交易，验证各账户的交易独立性和数据隔离性。

**Acceptance Scenarios**:

1. **Given** 系统配置了3个不同的用户账户，**When** 所有账户同时启动自动交易，**Then** 每个账户的订单、余额、交易记录完全隔离且互不影响
2. **Given** 多个用户同时交易同一Alpha代币，**When** 系统为不同用户创建订单，**Then** 每个用户使用自己的认证信息和账户资金
3. **Given** 某个用户的交易出现错误，**When** 系统处理该错误，**Then** 其他用户的交易不受影响继续正常运行

---

### User Story 7 - 交易进度追踪和统计 (Priority: P3)

作为交易员，我需要能够查看当前的交易进度，包括已完成的交易量、剩余目标交易量、已执行的循环次数等，以便了解交易执行情况。

**Why this priority**: 进度追踪帮助用户了解自动交易的执行状态，虽然不是核心交易功能，但对用户体验和监控很重要。

**Independent Test**: 可以通过执行若干轮交易后查看统计数据，验证数据的准确性和实时性。

**Acceptance Scenarios**:

1. **Given** 系统已执行了5轮OTO交易，**When** 用户查看交易统计，**Then** 系统显示准确的已完成交易量、成交次数、平均成交价格等数据
2. **Given** 用户设置了目标交易量为1000 USDT且已完成600 USDT，**When** 用户查看进度，**Then** 系统显示60%的完成进度和预计剩余循环次数
3. **Given** 交易正在进行中，**When** 用户实时查看交易记录，**Then** 系统显示每笔订单的详细信息（订单ID、价格、数量、状态、时间等）

---

### Edge Cases

- **余额不足时**：当用户余额不足以支持计算出的订单数量时，系统暂停自动交易并通知用户充值，不自动调整订单数量以保证交易一致性
- **网络连接中断**：当与交易所的WebSocket连接（价格数据或订单推送）中断时，系统立即暂停自动交易并通知用户，重连成功后需要用户手动核实订单状态并决定是否恢复交易，不自动恢复以保证资金安全
- **订单部分成交超时**：当OTO订单长时间处于部分成交状态并超过超时时间时，系统取消所有未成交部分，将已成交部分计入交易量，然后按最新价格重新创建新的OTO订单对
- **价格剧烈波动**：系统监控最近1分钟内的价格变动百分比，当变动超过用户配置的阈值（如2%）时，立即暂停自动交易以避免在价格异常波动时下单
- **认证过期**：用户的headers和cookies存储在数据库中，当系统检测到认证失效（如API返回认证错误），立即暂停自动交易并通知用户需要更新数据库中的认证信息，系统不自动刷新认证
- **重复订单风险**：系统通过订单状态机防止重复提交，基于WebSocket订单推送维护订单状态，只有确认当前OTO订单对完全成交后才允许下一个订单。如果推送严重延迟或丢失导致连接中断，系统会暂停交易等待人工核实
- **交易所限流**：系统通过aiolimiter库控制每用户的API请求频率在10 requests/second以内，避免触发交易所限流或被封禁。当检测到429状态码（限流响应）时，系统立即暂停该用户的自动交易并通知用户
- **代币符号映射缺失**：当用户配置的代币简称在本地符号映射表中不存在时，系统暂停交易并通知用户该代币未配置映射关系
- **精度信息缓存失效**：当本地缓存的精度信息过期或损坏时，系统自动调用API重新获取精度信息并更新缓存，如果API调用失败则暂停交易通知用户

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统必须支持多个用户账户的独立管理，每个用户的账户数据、配置和交易记录完全隔离
- **FR-002**: 系统必须能够查询并显示每个用户的账户余额信息，包括可用余额、冻结余额和总余额
- **FR-003**: 系统必须能够查询并统计每个用户在指定时间段内的累计交易量和交易次数
- **FR-004**: 用户必须能够配置目标交易量参数，系统根据此参数指导自动交易的执行
- **FR-005**: 系统必须能够根据用户的当前交易量和目标交易量，自动计算需要执行的交易循环次数
- **FR-006**: 系统必须能够实时接收Alpha代币的最新成交价格数据
- **FR-007**: 系统必须能够基于最新成交价格，按照用户配置的定价策略计算买单和卖单的价格，支持两种偏移模式：百分比偏移（如买单价格=最新成交价×(1-偏移百分比)）或固定金额偏移（如买单价格=最新成交价-偏移金额）
- **FR-008**: 系统必须能够创建OTO（一触发另一）订单对，包含一个买单和一个卖单
- **FR-009**: 系统必须能够将创建的订单提交到币安交易所
- **FR-010**: 系统必须能够实时监控已提交订单的状态变化（未成交、部分成交、完全成交、取消等）
- **FR-011**: 系统必须维护订单状态机，基于WebSocket订单推送更新状态，只有在OTO订单的买卖双方都完全成交后，状态机才允许开始下一轮交易循环，防止重复提交订单
- **FR-012**: 系统必须能够识别并跟踪订单的部分成交状态，记录部分成交的数量和金额，当超时发生时触发取消和重新下单流程
- **FR-013**: 系统必须能够记录每笔交易的详细信息，包括订单ID、价格、数量、成交时间、成交状态等
- **FR-014**: 系统必须能够显示当前交易进度，包括已完成交易量、完成百分比、剩余目标等
- **FR-015**: 系统必须使用用户提供的认证信息（headers和cookies）来访问交易所接口
- **FR-016**: 系统必须在检测到WebSocket连接中断、认证失效等异常时，立即暂停自动交易并通知用户，重连成功后不自动恢复交易，需要用户手动核实订单状态后再决定是否恢复
- **FR-017**: 系统必须在下单前检查用户余额，当余额不足以支持配置的订单数量时，暂停自动交易并通过通知机制告知用户需要充值
- **FR-018**: 系统必须在订单超过配置的超时时间仍未完全成交时，取消整个OTO订单对中所有未成交的部分，将已成交部分计入交易量，然后按最新市场价格重新创建并提交新的OTO订单对
- **FR-019**: 系统必须支持用户启动、暂停和停止自动交易流程
- **FR-020**: 系统必须监控最近1分钟内的价格变动百分比，当变动超过用户配置的波动阈值（如2%）时，立即暂停自动交易并通知用户，避免在价格异常波动期间下单
- **FR-021**: 系统必须将用户的认证信息（headers和cookies）存储在数据库中，启动交易时从数据库读取认证信息，当检测到认证失效时通知用户更新数据库中的认证数据
- **FR-022**: 用户配置交易时必须使用代币简称（如KOGE），系统内部维护代币简称到不同API符号格式的映射关系，支持订单API（alpha_xxx格式）和WebSocket（其他格式）等多种符号格式
- **FR-023**: 系统必须通过私有API查询代币的精度信息（包括交易精度tradeDecimal和代币精度decimals）并缓存到本地存储
- **FR-024**: 系统在需要代币精度信息时，必须优先从本地缓存读取，仅当缓存未命中时才调用API获取并更新缓存
- **FR-025**: 系统必须存储代币的基本信息到本地，包括代币简称、完整名称、不同API的符号映射、精度信息等
- **FR-026**: 系统必须根据不同的API请求场景，自动使用正确的代币符号格式（订单API使用alpha_xxx，WebSocket订阅使用对应的WebSocket符号）

### Non-Functional Requirements

- **NFR-001**: 系统必须在接收到价格或订单状态更新后的2秒内完成处理
- **NFR-002**: 系统必须能够同时支持至少10个用户并发进行自动交易
- **NFR-003**: 系统必须通过订单状态机保证订单数据的准确性，基于WebSocket实时推送维护状态，避免重复下单或遗漏订单状态变化，状态机必须确保同一时刻只有一个活跃的OTO订单对
- **NFR-004**: 系统必须控制与交易所的请求频率在每用户10 requests/second以内，避免触发限流或被封禁（具体阈值可根据交易所实际限制调整）
- **NFR-005**: 系统必须提供足够的日志记录，便于追踪问题和审计交易记录
- **NFR-006**: 系统必须对存储在数据库中的用户认证信息（headers和cookies）进行加密存储，确保敏感数据安全

### Key Entities *(include if feature involves data)*

- **用户账户（User Account）**: 代表一个交易账户，包含用户标识、账户余额、关联的认证信息ID（外键指向认证信息表）、交易配置等
- **认证信息（Authentication Credentials）**: 存储在数据库中的用户认证数据，包括headers、cookies、关联的用户账户ID、创建时间、最后验证时间等
- **交易配置（Trading Configuration）**: 用户设置的交易参数，包括目标交易量、价格偏移策略（百分比或固定金额模式）、买单偏移值、卖单偏移值、超时时间、订单数量、价格波动阈值（如2%）、代币简称（如KOGE）等
- **代币符号映射（Token Symbol Mapping）**: 存储代币简称到不同API符号格式的映射关系，包括代币简称（如KOGE）、订单API符号（如ALPHA_123格式）、WebSocket符号、代币全称等
- **代币精度缓存（Token Precision Cache）**: 本地缓存的代币精度信息，包括代币简称、交易精度tradeDecimal、代币精度decimals、缓存时间、最后更新时间等
- **OTO订单对（OTO Order Pair）**: 一个买单和一个卖单的组合，代表一次完整的双向交易
- **订单（Order）**: 单个买单或卖单，包含订单ID、类型（买/卖）、价格、数量、状态、提交时间、成交时间等
- **订单状态机（Order State Machine）**: 控制订单生命周期的状态机，通过WebSocket订单推送更新状态，确保同一时刻只有一个活跃的OTO订单对，防止重复下单，状态包括：空闲、下单中、等待成交、部分成交、完全成交、超时处理等
- **成交记录（Trade Record）**: 订单成交后的记录，包含成交价格、成交数量、成交时间等
- **交易统计（Trading Statistics）**: 用户的交易统计数据，包括累计交易量、交易次数、完成进度等
- **价格数据（Price Data）**: Alpha代币的实时市场价格，包括最新成交价、时间戳、价格历史（用于计算1分钟内的波动百分比）等

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 用户能够在登录后5秒内查看到准确的账户余额和交易量统计
- **SC-002**: 系统能够在接收到最新成交价格后10秒内完成订单价格计算并提交订单
- **SC-003**: OTO订单完全成交后，系统能够在30秒内启动下一轮交易循环
- **SC-004**: 系统能够同时支持至少10个用户账户进行自动交易，每个账户的数据完全隔离且无干扰
- **SC-005**: 95%的订单状态更新能够在发生变化后2秒内被系统接收到
- **SC-006**: 系统在连续运行8小时内，订单数据准确率达到100%（无重复下单、无遗漏状态）
- **SC-007**: 用户设置交易配置后，系统能够准确计算出所需的交易循环次数，误差不超过1次
- **SC-008**: 90%的用户能够在不借助技术支持的情况下完成交易配置和启动自动交易
- **SC-009**: 系统在检测到异常（连接中断、认证失效、余额不足）时，能够在10秒内暂停交易并通知用户
- **SC-010**: 系统的请求频率控制有效，在连续运行24小时内不触发交易所的限流措施

## Assumptions

1. 假设用户已经拥有币安账户并能够提供有效的认证信息（headers和cookies）存入数据库
2. 假设用户了解OTO订单的概念和风险
3. 假设Alpha代币在币安交易所有足够的流动性，订单能够在合理时间内成交
4. 假设用户会定期检查并更新数据库中的认证信息以保持有效性
5. 假设交易所提供的价格数据推送和订单状态推送服务稳定可靠
6. 假设用户已理解自动交易的风险并自行承担交易结果
7. 假设订单价格偏移量、价格波动阈值等定价策略参数由用户提供，系统按配置执行
8. 假设订单超时时间的合理默认值为5分钟，价格波动阈值的合理默认值为2%（均可由用户配置）
9. 假设系统部署环境网络稳定，能够与币安交易所保持长连接
10. 假设数据库能够安全存储用户的敏感认证信息，系统层面需要实施适当的加密和访问控制
11. 假设系统管理员会预先配置常用代币的符号映射关系（代币简称到订单API符号、WebSocket符号的映射）
12. 假设本地缓存的精度信息在合理时间内（如24小时）不会发生变化，交易所的精度配置相对稳定
13. 假设用户配置的代币简称与系统预配置的符号映射表一致，使用标准的代币简称（如KOGE、BTC等）

## Out of Scope

以下功能明确不在本期范围内：

1. **自动策略优化**：系统不会自动分析市场并调整交易策略，所有策略参数需用户配置
2. **风险管理**：系统不提供止损、止盈等高级风险管理功能（仅提供价格波动暂停保护）
3. **市场分析**：系统不提供K线图、技术指标等市场分析工具
4. **多交易所支持**：仅支持币安交易所，不支持其他交易平台
5. **多币种支持**：仅支持Alpha代币，不支持其他加密货币交易
6. **认证信息自动刷新**：系统将认证信息存储在数据库中但不负责自动获取或刷新，用户需自行更新数据库中的认证信息
7. **历史数据回测**：系统不提供策略回测功能
8. **移动端应用**：本期仅提供后端服务和基础界面，不包含移动端APP
9. **社交功能**：不包含用户间交流、策略分享等社交功能
10. **高级订单类型**：仅支持OTO订单，不支持限价单、市价单、条件单等其他订单类型作为独立功能
