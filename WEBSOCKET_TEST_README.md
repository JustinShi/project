# è®¢å• WebSocket æ¨é€æµ‹è¯•

## å¿«é€Ÿå¼€å§‹

å·²ä¸ºæ‚¨åˆ›å»ºå®Œæ•´çš„è®¢å• WebSocket æ¨é€æµ‹è¯•ç³»ç»Ÿã€‚

### è¿è¡Œæµ‹è¯•

```bash
# æµ‹è¯•è®¢å• WebSocket æ¨é€ï¼ˆ30ç§’ï¼‰
uv run python scripts/test_order_ws_final.py --user 1 --duration 30
```

### åŒæ—¶è§¦å‘è®¢å•ï¼ˆåœ¨å¦ä¸€ä¸ªç»ˆç«¯ï¼‰

```bash
# è§¦å‘äº¤æ˜“ç­–ç•¥ï¼Œç”Ÿæˆè®¢å•
uv run python scripts/quick_start_strategy.py --token KOGE --chain BSC --volume 20 --amount 10 --user 1 --interval 5
```

## æµ‹è¯•è„šæœ¬

### ä¸»è¦æµ‹è¯•è„šæœ¬

| è„šæœ¬ | åŠŸèƒ½ | ç”¨é€” |
|-----|------|-----|
| `test_order_ws_final.py` | å®Œæ•´æµ‹è¯• | è·å–å‡­è¯ + ListenKey + WebSocket è¿æ¥ + è®¢å•ç›‘å¬ |
| `test_order_ws_simple.py` | ç®€åŒ–æµ‹è¯• | ä»…æµ‹è¯•å‡­è¯è·å–å’Œ ListenKey |
| `test_listen_key_quick.py` | å¿«é€Ÿæµ‹è¯• | å¿«é€ŸéªŒè¯ ListenKey è·å–åŠŸèƒ½ |

### å…¶ä»–ç›¸å…³è„šæœ¬

| è„šæœ¬ | åŠŸèƒ½ |
|-----|------|
| `test_order_websocket.py` | æ—©æœŸç‰ˆæœ¬ï¼ˆè¾ƒå¤æ‚ï¼‰ |
| `test_order_ws_direct.py` | ä½¿ç”¨ç¯å¢ƒå˜é‡å‡­è¯ |

## åŠŸèƒ½ç‰¹æ€§

âœ… **å·²å®ç°çš„åŠŸèƒ½**:

1. **ListenKey ç®¡ç†**
   - è‡ªåŠ¨è·å– ListenKey
   - è‡ªåŠ¨ç»­æœŸï¼ˆæ¯30åˆ†é’Ÿï¼‰
   - è¿‡æœŸæ£€æµ‹å’Œåˆ·æ–°

2. **WebSocket è¿æ¥**
   - å»ºç«‹åˆ°å¸å®‰çš„ WebSocket è¿æ¥
   - è®¢é˜…è®¢å•æ¨é€é¢‘é“: `alpha@{listenKey}`
   - è‡ªåŠ¨é‡è¿ï¼ˆæŒ‡æ•°é€€é¿ç­–ç•¥ï¼‰
   - è¿æ¥çŠ¶æ€ç›‘æ§

3. **è®¢å•æ¨é€å¤„ç†**
   - å®æ—¶æ¥æ”¶è®¢å•çŠ¶æ€æ›´æ–°
   - è§£æ `executionReport` äº‹ä»¶
   - æ˜¾ç¤ºè®¢å•è¯¦ç»†ä¿¡æ¯
   - ç»Ÿè®¡è®¢å•çŠ¶æ€åˆ†å¸ƒ

4. **ä¼˜é›…åœæ­¢**
   - æ”¯æŒ Ctrl+C ä¸­æ–­
   - è‡ªåŠ¨æ¸…ç†èµ„æº
   - æ˜¾ç¤ºæµ‹è¯•ç»Ÿè®¡ä¿¡æ¯

## æµ‹è¯•è¾“å‡ºç¤ºä¾‹

### æˆåŠŸè¿æ¥

```
================================================================================
ğŸš€ æµ‹è¯•è®¢å• WebSocket æ¨é€
================================================================================
ç”¨æˆ·ID: 1
æµ‹è¯•æ—¶é•¿: 30 ç§’

âœ… ç”¨æˆ·å‡­è¯è·å–æˆåŠŸ
âœ… ListenKey è·å–æˆåŠŸ
   ListenKey: pqIA6YaQJw...
âœ… WebSocket è¿æ¥å™¨åˆ›å»ºæˆåŠŸ
âœ… WebSocket è¿æ¥å·²å»ºç«‹

ğŸ“Š è¿æ¥ä¿¡æ¯:
   ç”¨æˆ·ID: 1
   å·²è¿æ¥: True
   é‡è¿å°è¯•: 0/10

ğŸ’¡ æç¤º:
   - è¯·ä½¿ç”¨ quick_start_strategy.py è„šæœ¬è§¦å‘è®¢å•
   - æˆ–åœ¨å¸å®‰ Alpha å¹³å°æ‰‹åŠ¨ä¸‹å•
   - æŒ‰ Ctrl+C åœæ­¢æµ‹è¯•

â³ ç­‰å¾…è®¢å•æ›´æ–°ï¼ˆ30 ç§’ï¼‰...
```

### æ¥æ”¶åˆ°è®¢å•æ¨é€

```
================================================================================
ğŸ“¦ è®¢å•æ›´æ–° #1
--------------------------------------------------------------------------------
è®¢å•ä¿¡æ¯:
   ç”¨æˆ·ID: 1
   è®¢å•ID: 51481849
   å®¢æˆ·ç«¯è®¢å•ID: web_164e079573c1491795e1ee245d5ed293
   äº¤æ˜“å¯¹: ALPHA_373USDT
   æ–¹å‘: BUY
   ç±»å‹: LIMIT
   çŠ¶æ€: NEW
   ä»·æ ¼: 0.23000000
   æ•°é‡: 869.56000000
   å·²æ‰§è¡Œ: 0
================================================================================
```

### æµ‹è¯•ç»Ÿè®¡

```
================================================================================
ğŸ“Š æµ‹è¯•ç»Ÿè®¡
================================================================================
æ€»è®¢å•æ›´æ–°æ•°: 4
è¿æ¥äº‹ä»¶æ•°: 2

è®¢å•çŠ¶æ€åˆ†å¸ƒ:
   FILLED: 2
   NEW: 2
================================================================================

âœ… æµ‹è¯•å®Œæˆ
```

## WebSocket æ¶ˆæ¯ç±»å‹

### è®¢å•çŠ¶æ€

- `NEW` - æ–°è®¢å•å·²æ¥å—
- `PARTIALLY_FILLED` - éƒ¨åˆ†æˆäº¤
- `FILLED` - å®Œå…¨æˆäº¤
- `CANCELED` - å·²å–æ¶ˆ
- `REJECTED` - å·²æ‹’ç»
- `EXPIRED` - å·²è¿‡æœŸ

### æ¶ˆæ¯å­—æ®µ

| å­—æ®µ | è¯´æ˜ |
|-----|------|
| `i` | è®¢å•IDï¼ˆäº¤æ˜“æ‰€ï¼‰ |
| `c` | å®¢æˆ·ç«¯è®¢å•ID |
| `s` | äº¤æ˜“å¯¹ç¬¦å· |
| `S` | è®¢å•æ–¹å‘ (BUY/SELL) |
| `X` | è®¢å•çŠ¶æ€ |
| `p` | è®¢å•ä»·æ ¼ |
| `q` | è®¢å•æ•°é‡ |
| `z` | ç´¯è®¡æˆäº¤æ•°é‡ |

## æŠ€æœ¯æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æµ‹è¯•è„šæœ¬                                 â”‚
â”‚            test_order_ws_final.py                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ListenKeyManager  â”‚    â”‚ OrderWebSocket     â”‚
â”‚                    â”‚    â”‚    Connector       â”‚
â”‚  - è·å– ListenKey  â”‚    â”‚ - å»ºç«‹ WS è¿æ¥     â”‚
â”‚  - è‡ªåŠ¨ç»­æœŸ        â”‚    â”‚ - è®¢é˜…æ¨é€         â”‚
â”‚  - è¿‡æœŸæ£€æµ‹        â”‚    â”‚ - è‡ªåŠ¨é‡è¿         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                         â”‚
          â”‚ ListenKey               â”‚ WebSocket
          â”‚                         â”‚ Messages
          â–¼                         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚         å¸å®‰ API / WebSocket         â”‚
    â”‚  - userDataStream (ListenKey)       â”‚
    â”‚  - wss://nbstream.binance.com       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æ ¸å¿ƒç»„ä»¶

### 1. ListenKeyManager

**æ–‡ä»¶**: `src/binance/infrastructure/binance_client/listen_key_manager.py`

**èŒè´£**:
- è°ƒç”¨å¸å®‰ API è·å– ListenKey
- æ¯30åˆ†é’Ÿè‡ªåŠ¨ç»­æœŸ
- æ£€æµ‹è¿‡æœŸå¹¶è‡ªåŠ¨åˆ·æ–°

### 2. OrderWebSocketConnector

**æ–‡ä»¶**: `src/binance/infrastructure/binance_client/order_websocket.py`

**èŒè´£**:
- å»ºç«‹ WebSocket è¿æ¥
- è®¢é˜… `alpha@{listenKey}` é¢‘é“
- æ¥æ”¶å’Œè§£æè®¢å•æ¶ˆæ¯
- æ–­çº¿è‡ªåŠ¨é‡è¿

### 3. BinanceWebSocketClient

**æ–‡ä»¶**: `src/binance/infrastructure/binance_client/websocket_client.py`

**èŒè´£**:
- åº•å±‚ WebSocket é€šä¿¡
- å¿ƒè·³æ£€æµ‹
- é‡è¿é€»è¾‘

## æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: ListenKey è·å–å¤±è´¥

**ç—‡çŠ¶**: `âŒ è·å– ListenKey å¤±è´¥`

**åŸå› **:
- ç”¨æˆ·å‡­è¯æ— æ•ˆæˆ–è¿‡æœŸ
- ç½‘ç»œè¿æ¥é—®é¢˜
- éœ€è¦è¡¥å……è®¤è¯

**è§£å†³**:
1. æ£€æŸ¥æ•°æ®åº“ä¸­çš„ç”¨æˆ·å‡­è¯
2. æ›´æ–° headers ä¸­çš„è®¤è¯ token
3. å®Œæˆå¸å®‰å¹³å°çš„è¡¥å……è®¤è¯

### é—®é¢˜ 2: WebSocket è¿æ¥å¤±è´¥

**ç—‡çŠ¶**: `âš ï¸  WebSocket è¿æ¥æœªå»ºç«‹`

**åŸå› **:
- ListenKey æ— æ•ˆ
- ç½‘ç»œé—®é¢˜
- å¸å®‰ WebSocket æœåŠ¡æ•…éšœ

**è§£å†³**:
1. é‡æ–°è·å– ListenKey
2. æ£€æŸ¥ç½‘ç»œè¿æ¥
3. æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶è·å–è¯¦ç»†é”™è¯¯

### é—®é¢˜ 3: æ²¡æœ‰æ¥æ”¶åˆ°è®¢å•æ¨é€

**ç—‡çŠ¶**: è¿æ¥æˆåŠŸä½†æ²¡æœ‰æ¶ˆæ¯

**åŸå› **:
- æ²¡æœ‰å®é™…è®¢å•è§¦å‘
- WebSocket è®¢é˜…æœªæˆåŠŸ

**è§£å†³**:
1. ä½¿ç”¨ `quick_start_strategy.py` è§¦å‘è®¢å•
2. æ£€æŸ¥ WebSocket è¿æ¥çŠ¶æ€
3. æŸ¥çœ‹æ—¥å¿—ä¸­çš„è®¢é˜…ç¡®è®¤æ¶ˆæ¯

## ç›¸å…³æ–‡æ¡£

- ğŸ“– [è¯¦ç»†æµ‹è¯•æŒ‡å—](docs/order_websocket_test_guide.md)
- ğŸ“– [WebSocket æ¶ˆæ¯æ ¼å¼](specs/001-lpha-oto/contracts/websocket-messages.yaml)
- ğŸ“– [å¸å®‰ API æ–‡æ¡£](docs/binance/api.md)

## ç‰ˆæœ¬ä¿¡æ¯

- **åˆ›å»ºæ—¥æœŸ**: 2025-10-10
- **ç‰ˆæœ¬**: 1.0.0
- **çŠ¶æ€**: âœ… å·²æµ‹è¯•

## ä¸‹ä¸€æ­¥

1. âœ… è¿è¡Œ `test_order_ws_final.py` éªŒè¯ WebSocket è¿æ¥
2. âœ… ä½¿ç”¨ `quick_start_strategy.py` è§¦å‘è®¢å•
3. âœ… è§‚å¯Ÿè®¢å•æ¨é€æ¶ˆæ¯
4. âœ… æ£€æŸ¥ç»Ÿè®¡ä¿¡æ¯æ˜¯å¦æ­£ç¡®

---

**æç¤º**: å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶æˆ–å‚è€ƒè¯¦ç»†æµ‹è¯•æŒ‡å—ã€‚

