# è®¢å• WebSocket æ¨é€æµ‹è¯•æŒ‡å—

## æ¦‚è¿°

æœ¬æ–‡æ¡£ä»‹ç»å¦‚ä½•æµ‹è¯•å¸å®‰ Alpha äº¤æ˜“ç³»ç»Ÿçš„è®¢å• WebSocket æ¨é€åŠŸèƒ½ã€‚

## æµ‹è¯•æ¶æ„

```
ç”¨æˆ·å‡­è¯(æ•°æ®åº“)
     â†“
ListenKey è·å– (API)
     â†“
WebSocket è¿æ¥ (wss://nbstream.binance.com/w3w/stream)
     â†“
è®¢é˜…: alpha@{listenKey}
     â†“
æ¥æ”¶è®¢å•æ¨é€ (executionReport)
```

## æµ‹è¯•è„šæœ¬

### 1. å®Œæ•´æµ‹è¯•è„šæœ¬

**æ–‡ä»¶**: `scripts/test_order_ws_final.py`

**åŠŸèƒ½**:
- ä»æ•°æ®åº“è·å–ç”¨æˆ·å‡­è¯
- è·å– ListenKey
- å»ºç«‹ WebSocket è¿æ¥
- ç›‘å¬è®¢å•æ¨é€
- å®æ—¶æ˜¾ç¤ºè®¢å•æ›´æ–°
- ç»Ÿè®¡è®¢å•çŠ¶æ€

**ç”¨æ³•**:

```bash
# æµ‹è¯•ç”¨æˆ·1ï¼ŒæŒç»­60ç§’ï¼ˆé»˜è®¤ï¼‰
uv run python scripts/test_order_ws_final.py

# æµ‹è¯•ç”¨æˆ·1ï¼ŒæŒç»­30ç§’
uv run python scripts/test_order_ws_final.py --user 1 --duration 30

# æµ‹è¯•ç”¨æˆ·2ï¼ŒæŒç»­120ç§’
uv run python scripts/test_order_ws_final.py --user 2 --duration 120
```

**å‚æ•°**:
- `--user`: ç”¨æˆ·IDï¼ˆé»˜è®¤: 1ï¼‰
- `--duration`: æµ‹è¯•æ—¶é•¿ï¼Œå•ä½ç§’ï¼ˆé»˜è®¤: 60ï¼‰

### 2. ListenKey å¿«é€Ÿæµ‹è¯•

**æ–‡ä»¶**: `scripts/test_listen_key_quick.py`

**åŠŸèƒ½**:
- å¿«é€Ÿæµ‹è¯• ListenKey è·å–
- æ˜¾ç¤º WebSocket è¿æ¥ä¿¡æ¯

**ç”¨æ³•**:

```bash
uv run python scripts/test_listen_key_quick.py
```

### 3. ç®€åŒ–æµ‹è¯•ï¼ˆæ•°æ®åº“ç‰ˆï¼‰

**æ–‡ä»¶**: `scripts/test_order_ws_simple.py`

**åŠŸèƒ½**:
- ä»æ•°æ®åº“è·å–å‡­è¯
- æµ‹è¯• ListenKey è·å–
- ä¸å»ºç«‹å®é™… WebSocket è¿æ¥

## æµ‹è¯•æ­¥éª¤

### æ­¥éª¤ 1: å‡†å¤‡ç”¨æˆ·å‡­è¯

ç¡®ä¿æ•°æ®åº“ä¸­æœ‰ç”¨æˆ·å‡­è¯é…ç½®ï¼š

```sql
SELECT id, name, headers IS NOT NULL as has_headers, 
       cookies IS NOT NULL as has_cookies 
FROM users 
WHERE id = 1;
```

å¦‚æœæ²¡æœ‰å‡­è¯ï¼Œè¯·æ›´æ–°ï¼š

```sql
UPDATE users 
SET headers = '{"x-passthrough-token":"...","csrftoken":"..."}',
    cookies = 'cookie1=value1; cookie2=value2'
WHERE id = 1;
```

### æ­¥éª¤ 2: å¯åŠ¨ WebSocket æµ‹è¯•

åœ¨ä¸€ä¸ªç»ˆç«¯çª—å£ä¸­è¿è¡Œï¼š

```bash
uv run python scripts/test_order_ws_final.py --user 1 --duration 60
```

é¢„æœŸè¾“å‡ºï¼š

```
================================================================================
ğŸš€ æµ‹è¯•è®¢å• WebSocket æ¨é€
================================================================================
ç”¨æˆ·ID: 1
æµ‹è¯•æ—¶é•¿: 60 ç§’

âœ… ç”¨æˆ·å‡­è¯è·å–æˆåŠŸ
âœ… ListenKey è·å–æˆåŠŸ
   ListenKey: pqIA6YaQJw...
âœ… WebSocket è¿æ¥å™¨åˆ›å»ºæˆåŠŸ
âœ… WebSocket è¿æ¥å·²å»ºç«‹

ğŸ“Š è¿æ¥ä¿¡æ¯:
   ç”¨æˆ·ID: 1
   å·²è¿æ¥: True
   é‡è¿å°è¯•: 0/10

ğŸ’¡ æç¤º:
   - è¯·ä½¿ç”¨ quick_start_strategy.py è„šæœ¬è§¦å‘è®¢å•
   - æˆ–åœ¨å¸å®‰ Alpha å¹³å°æ‰‹åŠ¨ä¸‹å•
   - æŒ‰ Ctrl+C åœæ­¢æµ‹è¯•

â³ ç­‰å¾…è®¢å•æ›´æ–°ï¼ˆ60 ç§’ï¼‰...
```

### æ­¥éª¤ 3: è§¦å‘è®¢å•ï¼ˆå¯é€‰ï¼‰

åœ¨å¦ä¸€ä¸ªç»ˆç«¯çª—å£ä¸­è¿è¡Œäº¤æ˜“ç­–ç•¥ï¼š

```bash
uv run python scripts/quick_start_strategy.py --token KOGE --chain BSC --volume 20 --amount 10 --user 1 --interval 5
```

### æ­¥éª¤ 4: è§‚å¯Ÿ WebSocket æ¨é€

å½“è®¢å•è¢«åˆ›å»ºæˆ–æ›´æ–°æ—¶ï¼Œæµ‹è¯•è„šæœ¬ä¼šå®æ—¶æ˜¾ç¤ºï¼š

```
================================================================================
ğŸ“¦ è®¢å•æ›´æ–° #1
--------------------------------------------------------------------------------
è®¢å•ä¿¡æ¯:
   ç”¨æˆ·ID: 1
   è®¢å•ID: 51481849
   å®¢æˆ·ç«¯è®¢å•ID: web_164e079573c1491795e1ee245d5ed293
   äº¤æ˜“å¯¹: ALPHA_373USDT
   æ–¹å‘: BUY
   ç±»å‹: LIMIT
   çŠ¶æ€: NEW
   ä»·æ ¼: 0.23000000
   æ•°é‡: 869.56000000
   å·²æ‰§è¡Œ: 0
================================================================================
```

## WebSocket æ¶ˆæ¯æ ¼å¼

### è®¢å•æ‰§è¡ŒæŠ¥å‘Š (executionReport)

**å­—æ®µè¯´æ˜**:

| å­—æ®µ | è¯´æ˜ |
|-----|-----|
| `e` | äº‹ä»¶ç±»å‹ (executionReport) |
| `s` | äº¤æ˜“å¯¹ç¬¦å· |
| `c` | å®¢æˆ·ç«¯è®¢å•ID |
| `S` | è®¢å•æ–¹å‘ (BUY/SELL) |
| `o` | è®¢å•ç±»å‹ (LIMIT/MARKET) |
| `X` | è®¢å•çŠ¶æ€ (NEW/FILLED/CANCELEDç­‰) |
| `i` | è®¢å•IDï¼ˆäº¤æ˜“æ‰€ï¼‰ |
| `p` | è®¢å•ä»·æ ¼ |
| `q` | è®¢å•æ•°é‡ |
| `z` | ç´¯è®¡æˆäº¤æ•°é‡ |
| `L` | æœ€åæˆäº¤ä»·æ ¼ |
| `n` | æ‰‹ç»­è´¹ |
| `N` | æ‰‹ç»­è´¹èµ„äº§ |

### è®¢å•çŠ¶æ€æšä¸¾

| çŠ¶æ€ | è¯´æ˜ |
|-----|-----|
| NEW | æ–°è®¢å•å·²æ¥å— |
| PARTIALLY_FILLED | éƒ¨åˆ†æˆäº¤ |
| FILLED | å®Œå…¨æˆäº¤ |
| CANCELED | å·²å–æ¶ˆ |
| PENDING_CANCEL | å–æ¶ˆä¸­ |
| REJECTED | å·²æ‹’ç» |
| EXPIRED | å·²è¿‡æœŸ |

## æµ‹è¯•ç»Ÿè®¡

æµ‹è¯•ç»“æŸåä¼šæ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯ï¼š

```
================================================================================
ğŸ“Š æµ‹è¯•ç»Ÿè®¡
================================================================================
æ€»è®¢å•æ›´æ–°æ•°: 5
è¿æ¥äº‹ä»¶æ•°: 2

è®¢å•çŠ¶æ€åˆ†å¸ƒ:
   FILLED: 2
   NEW: 3
================================================================================

âœ… æµ‹è¯•å®Œæˆ
```

## å¸¸è§é—®é¢˜

### 1. ListenKey è·å–å¤±è´¥

**é”™è¯¯**: `âŒ è·å– ListenKey å¤±è´¥: HTTPé”™è¯¯: 401`

**è§£å†³**:
- æ£€æŸ¥ç”¨æˆ·å‡­è¯æ˜¯å¦æœ‰æ•ˆ
- ç¡®è®¤ headers ä¸­åŒ…å«æ­£ç¡®çš„è®¤è¯ token
- æ£€æŸ¥æ˜¯å¦éœ€è¦å®Œæˆè¡¥å……è®¤è¯

### 2. WebSocket è¿æ¥æœªå»ºç«‹

**é”™è¯¯**: `âš ï¸  WebSocket è¿æ¥æœªå»ºç«‹ï¼ˆå¯èƒ½æ­£åœ¨è¿æ¥ä¸­ï¼‰`

**è§£å†³**:
- ç­‰å¾…å‡ ç§’ï¼Œè¿æ¥å¯èƒ½éœ€è¦æ—¶é—´
- æ£€æŸ¥ç½‘ç»œè¿æ¥
- æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶ä¸­çš„è¯¦ç»†é”™è¯¯ä¿¡æ¯

### 3. æ²¡æœ‰æ¥æ”¶åˆ°è®¢å•æ¨é€

**åŸå› **:
- æ²¡æœ‰å®é™…è®¢å•è§¦å‘
- WebSocket è®¢é˜…æœªæˆåŠŸ
- ListenKey è¿‡æœŸ

**è§£å†³**:
- ä½¿ç”¨ `quick_start_strategy.py` è§¦å‘è®¢å•
- æ£€æŸ¥ WebSocket è¿æ¥çŠ¶æ€
- æŸ¥çœ‹æ—¥å¿—ä¸­æ˜¯å¦æœ‰è®¢é˜…ç¡®è®¤æ¶ˆæ¯

### 4. ç”¨æˆ·å‡­è¯ä¸ºç©º

**é”™è¯¯**: `âŒ ç”¨æˆ· 1 æ²¡æœ‰é…ç½®å‡­è¯`

**è§£å†³**:

```sql
-- æ›´æ–°ç”¨æˆ·å‡­è¯
UPDATE users 
SET headers = '{"x-passthrough-token":"your_token","csrftoken":"your_csrf"}',
    cookies = 'your_cookies_string'
WHERE id = 1;
```

## å®ç°ç»†èŠ‚

### ListenKey ç®¡ç†

**ä»£ç ä½ç½®**: `src/binance/infrastructure/binance_client/listen_key_manager.py`

**åŠŸèƒ½**:
- è·å– ListenKey (æœ‰æ•ˆæœŸ60åˆ†é’Ÿ)
- è‡ªåŠ¨ä¿æ´» (æ¯30åˆ†é’Ÿç»­æœŸ)
- è¿‡æœŸæ£€æµ‹å’Œè‡ªåŠ¨åˆ·æ–°

### WebSocket è¿æ¥å™¨

**ä»£ç ä½ç½®**: `src/binance/infrastructure/binance_client/order_websocket.py`

**åŠŸèƒ½**:
- å»ºç«‹ WebSocket è¿æ¥
- è®¢é˜…è®¢å•æ¨é€é¢‘é“
- è§£æè®¢å•æ¶ˆæ¯
- è‡ªåŠ¨é‡è¿ï¼ˆæŒ‡æ•°é€€é¿ï¼‰
- è¿æ¥çŠ¶æ€ç›‘æ§

### è®¢å•æ¨é€å¤„ç†

**æµç¨‹**:

```
WebSocket æ¥æ”¶æ¶ˆæ¯
     â†“
è§£æ JSON
     â†“
æ£€æŸ¥äº‹ä»¶ç±»å‹ (executionReport)
     â†“
æå–è®¢å•ä¿¡æ¯
     â†“
è°ƒç”¨å›è°ƒå‡½æ•°
     â†“
æ›´æ–°æœ¬åœ°è®¢å•çŠ¶æ€
```

## æµ‹è¯•æ¸…å•

- [ ] ListenKey è·å–æˆåŠŸ
- [ ] WebSocket è¿æ¥å»ºç«‹æˆåŠŸ
- [ ] æ¥æ”¶åˆ°è®¢å•åˆ›å»ºæ¨é€ (NEW)
- [ ] æ¥æ”¶åˆ°è®¢å•æˆäº¤æ¨é€ (FILLED)
- [ ] æ¥æ”¶åˆ°è®¢å•å–æ¶ˆæ¨é€ (CANCELED)
- [ ] WebSocket è‡ªåŠ¨é‡è¿æ­£å¸¸
- [ ] ListenKey è‡ªåŠ¨ç»­æœŸæ­£å¸¸
- [ ] ç»Ÿè®¡ä¿¡æ¯å‡†ç¡®
- [ ] Ctrl+C å¯ä»¥æ­£å¸¸åœæ­¢æµ‹è¯•

## å‚è€ƒæ–‡æ¡£

- [WebSocket æ¶ˆæ¯æ ¼å¼](../specs/001-lpha-oto/contracts/websocket-messages.yaml)
- [å¸å®‰ API æ–‡æ¡£](./binance/api.md)
- [è®¢å•æ‰§è¡ŒæœåŠ¡](../src/binance/application/services/order_execution_service.py)

## ç‰ˆæœ¬å†å²

- **v1.0.0** (2025-10-10)
  - åˆå§‹ç‰ˆæœ¬
  - æ”¯æŒåŸºæœ¬çš„è®¢å• WebSocket æ¨é€æµ‹è¯•
  - åŒ…å«å®Œæ•´çš„æµ‹è¯•è„šæœ¬å’Œæ–‡æ¡£

