# 价格计算说明（刷量策略）

## 📊 刷量策略核心逻辑

### ⚠️ 重要理解

**这是刷量策略，不是盈利策略！**

目标：制造交易量，而非获取利润
方式：高价买入 + 低价卖出 = 主动亏损

### 计算公式

```python
# 第一步：获取当前市场价格
市场价格 = 从 Binance API 获取的实时价格

# 第二步：计算买入价格（高于市价，确保成交）
买入价格 = 市场价格 × (1 + buy_offset_percentage / 100)

# 第三步：计算卖出价格（低于买价，快速卖出）
卖出价格 = 买入价格 × (1 - sell_profit_percentage / 100)
```

**关键点**：
- ✅ 买入价 > 市场价（溢价买入）
- ✅ 卖出价 < 买入价（折价卖出）
- ✅ 每笔交易都会亏损
- ✅ 目的是刷交易量

---

## 💡 实际代码

```python
# src/binance/application/services/strategy_executor.py

# 买入价格 = 市场价格 × (1 + buy_offset_percentage / 100)
buy_offset_multiplier = Decimal("1") + (strategy.buy_offset_percentage / Decimal("100"))
buy_value = (last_price * buy_offset_multiplier).quantize(
    Decimal("1e-8"), rounding=ROUND_DOWN
)

# 卖出价格 = 买入价格 × (1 - sell_profit_percentage / 100)
sell_discount_multiplier = Decimal("1") - (strategy.sell_profit_percentage / Decimal("100"))
sell_value = (buy_value * sell_discount_multiplier).quantize(
    Decimal("1e-8"), rounding=ROUND_DOWN
)
```

---

## 📈 计算示例

### 示例 1：默认配置（买入 +0.5%，卖出 -1.0%）

**假设市场价格 = 100 USDT**

```
步骤 1：获取市场价格
市场价格 = 100 USDT

步骤 2：计算买入价格（溢价 0.5%）
买入价格 = 100 × (1 + 0.5/100)
        = 100 × 1.005
        = 100.5 USDT

步骤 3：计算卖出价格（折扣 1.0%）
卖出价格 = 100.5 × (1 - 1.0/100)
        = 100.5 × 0.99
        = 99.495 USDT

结果：
- 市场价：100 USDT
- 买入价：100.5 USDT （高于市价 0.5 USDT，溢价 0.5%）
- 卖出价：99.495 USDT （低于买价 1.005 USDT，折扣 1.0%）
- 每笔亏损：1.005 USDT （亏损率 1.0%）
- 相对市价：亏损 0.505 USDT （-0.505%）
```

### 示例 2：KOGE 实际价格（市场价 48.24 USDT）

**配置：buy_offset_percentage = 0.5%, sell_profit_percentage = 1.0%**

```
市场价格 = 48.24 USDT

买入价格 = 48.24 × 1.005 = 48.4812 USDT
卖出价格 = 48.4812 × 0.99 = 48.036388 USDT

结果：
- 市场价：48.24 USDT
- 买入价：48.4812 USDT （+0.2412 USDT，+0.5%）
- 卖出价：48.036388 USDT （-0.444812 USDT，-1.0%）
- 每笔亏损：0.444812 USDT （-0.918%）
- 相对市价：亏损 0.203612 USDT （-0.422%）
```

### 示例 3：激进配置（买入 +1.0%，卖出 -2.0%）

**假设市场价格 = 50 USDT**

```
市场价格 = 50 USDT

买入价格 = 50 × 1.01 = 50.5 USDT
卖出价格 = 50.5 × 0.98 = 49.49 USDT

结果：
- 买入价：50.5 USDT （溢价 1.0%）
- 卖出价：49.49 USDT （折扣 2.0%）
- 每笔亏损：1.01 USDT （-2.0%）
- 相对市价：亏损 0.51 USDT（-1.02%）
```

### 示例 4：保守配置（买入 +0.1%，卖出 -0.3%）

**假设市场价格 = 200 USDT**

```
市场价格 = 200 USDT

买入价格 = 200 × 1.001 = 200.2 USDT
卖出价格 = 200.2 × 0.997 = 199.5994 USDT

结果：
- 买入价：200.2 USDT （溢价 0.1%）
- 卖出价：199.5994 USDT （折扣 0.3%）
- 每笔亏损：0.6006 USDT （-0.3%）
- 相对市价：亏损 0.4006 USDT（-0.2003%）
```

---

## 💰 成本分析

### 每笔交易成本计算

```
买入成本 = (买入价 - 市场价) / 市场价 × 100%
        = buy_offset_percentage

卖出亏损 = (买入价 - 卖出价) / 买入价 × 100%
        = sell_profit_percentage

总亏损率 = 卖出亏损（基于买入价）
```

### 成本对照表

| 配置 | 买入溢价 | 卖出折扣 | 每笔亏损率 | 1000 USDT 成本 |
|------|---------|---------|-----------|--------------|
| 默认 | +0.5% | -1.0% | ~1.0% | ~10 USDT |
| 激进 | +1.0% | -2.0% | ~2.0% | ~20 USDT |
| 保守 | +0.1% | -0.3% | ~0.3% | ~3 USDT |
| 极端 | +2.0% | -3.0% | ~3.0% | ~30 USDT |

### 刷量16384 USDT 的总成本

**默认配置（买入+0.5%，卖出-1.0%）**：

```
单笔交易金额：30 USDT
交易次数：16384 / 30 ≈ 546 次
每笔亏损率：~1.0%
总亏损：16384 × 1.0% ≈ 164 USDT
```

**成本对照**：

| 目标交易量 | 默认成本(1%) | 激进成本(2%) | 保守成本(0.3%) |
|-----------|-------------|-------------|---------------|
| 1,000 USDT | ~10 USDT | ~20 USDT | ~3 USDT |
| 5,000 USDT | ~50 USDT | ~100 USDT | ~15 USDT |
| 16,384 USDT | ~164 USDT | ~328 USDT | ~49 USDT |
| 50,000 USDT | ~500 USDT | ~1000 USDT | ~150 USDT |

---

## ⚙️ 配置参数

### 在配置文件中设置

```yaml
# config/trading_config.yaml

global_settings:
  default_buy_offset_percentage: 0.5     # 买入溢价 0.5%（高于市价）
  default_sell_profit_percentage: 1.0    # 卖出折扣 1.0%（低于买价）

strategies:
  - strategy_id: "my_strategy"
    # 可以覆盖全局默认值
    buy_offset_percentage: 0.3           # 自定义买入溢价 0.3%
    sell_profit_percentage: 0.5          # 自定义卖出折扣 0.5%
```

---

## 🎯 配置建议

### 1. 根据成本预算选择

| 预算类型 | buy_offset | sell_discount | 每笔亏损 | 适用场景 |
|---------|-----------|--------------|---------|---------|
| **低成本** | 0.1% - 0.3% | 0.3% - 0.5% | ~0.3-0.5% | 大量刷量 |
| **平衡** | 0.5% - 1.0% | 1.0% - 1.5% | ~1.0-1.5% | 默认推荐 |
| **快速** | 1.0% - 2.0% | 2.0% - 3.0% | ~2.0-3.0% | 快速成交 |

### 2. 根据代币流动性调整

| 流动性 | buy_offset | sell_discount | 说明 |
|-------|-----------|--------------|------|
| **高** | 0.1% - 0.5% | 0.3% - 1.0% | 大盘币，容易成交 |
| **中** | 0.5% - 1.0% | 1.0% - 2.0% | 一般代币 |
| **低** | 1.0% - 2.0% | 2.0% - 3.0% | 小盘币，需要更高溢价 |

---

## 🔄 完整交易流程

```
1. 获取市场价格
   市场价格 = 48.24 USDT

2. 计算买入价格（+0.5%）
   买入价格 = 48.24 × 1.005 = 48.4812 USDT

3. 计算卖出价格（-1.0%）
   卖出价格 = 48.4812 × 0.99 = 48.036388 USDT

4. 计算数量
   目标金额 = 30 USDT
   数量 = 30 / 48.4812 = 0.618730...
   数量（向下取整）= 0.61873000

5. 重新计算实际金额
   买入金额 = 0.61873000 × 48.4812 = ~30 USDT
   卖出金额 = 0.61873000 × 48.036388 = ~29.72 USDT
   亏损 = ~0.28 USDT

6. 下 OTO 订单
   买单：48.4812 USDT 买入 0.61873000 个代币
   卖单：48.036388 USDT 卖出 0.61873000 个代币
   预期亏损：~0.28 USDT (0.93%)
```

---

## 📊 实际日志示例

```json
{
  "symbol": "ALPHA_22USDT",
  "buy_price": "48.48120000",      // 买入价（市场价 + 0.5%）
  "sell_price": "47.99638800",     // 卖出价（买入价 - 1.0%）
  "quantity": "0.61873000",
  "buy_amount": "29.99999976",     // 买入花费约 30 USDT
  "sell_amount": "29.69999977",    // 卖出收回约 29.7 USDT
  "loss": "0.29999999",            // 亏损约 0.3 USDT (~1%)
  "event": "下OTO订单"
}
```

---

## 💡 常见问题

### Q1: 为什么要主动亏损？

**A**: 这是**刷量策略**，目的是：
- 增加代币的交易量
- 制造市场活跃度
- 提升代币在交易所的排名
- **不是为了盈利！**

### Q2: 卖出价为什么要低于买入价？

**A**: 确保快速卖出。OTO订单的逻辑是：
1. 买单以高价立即成交
2. 卖单以低价快速清仓
3. 完成一个交易循环，增加交易量

### Q3: 参数命名为什么叫 sell_profit_percentage？

**A**: 历史遗留命名，实际上是"卖出折扣率"。可以理解为：
- `sell_profit_percentage = 1.0` 表示卖出时折扣 1.0%
- 即卖出价 = 买入价 × 0.99

### Q4: 如何降低刷量成本？

**A**: 三种方法：

1. **降低买入溢价**
   ```yaml
   buy_offset_percentage: 0.3  # 从 0.5% 降到 0.3%
   ```

2. **降低卖出折扣**
   ```yaml
   sell_profit_percentage: 0.5  # 从 1.0% 降到 0.5%
   ```

3. **同时降低**（推荐）
   ```yaml
   buy_offset_percentage: 0.2
   sell_profit_percentage: 0.3
   # 每笔亏损约 0.3%
   ```

### Q5: 能否设置为盈利模式？

**A**: 理论上可以，但不推荐：

```yaml
# 盈利模式（不推荐，可能导致长时间挂单）
buy_offset_percentage: -0.5   # 低于市价买入
sell_profit_percentage: -1.0  # 高于买价卖出（负数表示加价）
```

**问题**：
- 买单可能长时间不成交
- 卖单可能长时间挂单
- 无法有效刷量

---

## 🛠️ 修改配置

### 全局修改（所有策略生效）

```yaml
# config/trading_config.yaml

global_settings:
  default_buy_offset_percentage: 0.3    # 买入溢价 0.3%
  default_sell_profit_percentage: 0.5   # 卖出折扣 0.5%
  # 每笔亏损约 0.5%
```

### 策略级修改（仅特定策略）

```yaml
strategies:
  - strategy_id: "koge_boost"
    buy_offset_percentage: 0.5          # 此策略买入溢价 0.5%
    sell_profit_percentage: 1.0         # 此策略卖出折扣 1.0%
```

### 用户级修改（用户自定义）

```yaml
user_overrides:
  - user_id: 1
    strategies:
      koge_boost:
        buy_offset_percentage: 1.0      # 用户1愿意承担更高成本
        sell_profit_percentage: 2.0
```

---

## 📝 总结

### 刷量策略核心

```
买入价 > 市场价（确保成交）
卖出价 < 买入价（快速清仓）
每笔交易 = 主动亏损
目的 = 制造交易量
```

### 推荐配置

| 场景 | buy_offset | sell_discount | 成本 |
|------|-----------|--------------|------|
| **低成本刷量** | 0.2% | 0.3% | ~0.3% |
| **平衡刷量** | 0.5% | 1.0% | ~1.0% |
| **快速刷量** | 1.0% | 2.0% | ~2.0% |

### 成本估算

```
目标交易量 = 16,384 USDT
配置 = 买入+0.5%, 卖出-1.0%
预计成本 = 16,384 × 1.0% ≈ 164 USDT
```

**记住：这是刷量策略，每笔交易都会亏损，这是正常的！** 🎯
